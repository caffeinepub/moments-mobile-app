{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 9,
  "summary": "Moments is a mobile-first React + TypeScript single-page app for planning small real-world moments (via a weekly calendar strip and “Plan a Moment” bottom sheet) and capturing private photo memories (camera → save confirmation → feeling check). The app is primarily local-first (planned moments, photo moments, and user profile stored in browser storage) with reactive UI updates via storage listeners and custom DOM events. It integrates Dfinity Internet Identity for authentication and includes a Motoko backend canister with role-based access control (admin bootstrap via environment token) plus early-stage profile/settings and photo-metadata APIs with incomplete blob storage wiring.",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Client-side routing across app screens",
      "synonyms": [
        "TanStack Router",
        "SPA navigation"
      ],
      "description": "Defines routes for splash (/), welcome (/welcome), home (/home), camera (/camera), save moment confirmation (/save-moment), feeling check (/feeling-check), calendar (/calendar), vault (/vault), vault detail (/vault/$momentId), profile (/profile), and settings (/settings).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "React Query provider setup",
      "synonyms": [
        "QueryClientProvider",
        "TanStack React Query"
      ],
      "description": "Initializes a shared QueryClient and wraps the app to enable cached queries and shared invalidation patterns.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Internet Identity authentication provider and hook",
      "synonyms": [
        "AuthClient integration",
        "InternetIdentityProvider"
      ],
      "description": "Manages identity hydration on mount, login/logout, and exposes status flags (initializing/idle/logging-in/success/loginError) plus error state.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Backend actor creation and caching per principal",
      "synonyms": [
        "useActor",
        "authenticated actor"
      ],
      "description": "Creates anonymous or authenticated backend actors depending on Internet Identity state, caches them with React Query keyed by principal, and triggers backend access-control initialization using a secret token from the URL hash.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Secure secret parameter extraction from URL hash with session persistence and scrubbing",
      "synonyms": [
        "getSecretParameter",
        "URL hash scrubbing"
      ],
      "description": "Utilities to extract sensitive parameters from the URL hash fragment, persist them in sessionStorage, and scrub them from the address bar via history.replaceState.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Mobile-first fixed viewport frame layout",
      "synonyms": [
        "390×844 container",
        "phone frame UI"
      ],
      "description": "Pages render within a centered viewport constrained to typical mobile dimensions with a full-screen backdrop for consistent layout across devices.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Animated onboarding splash slideshow (3 slides)",
      "synonyms": [
        "onboarding carousel",
        "3D transitions"
      ],
      "description": "Implements a 3-slide onboarding experience with long-duration 3D enter/exit transitions, autoplay progression, and Prev/Next navigation controls.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Splash cards support video and image media with preloading",
      "synonyms": [
        "mixed media slides",
        "autoplay video slide"
      ],
      "description": "Splash cards can render an autoplaying, muted looping video (playsInline) or eager-loaded images; index.html preloads splash assets for instant display.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "Auth-aware onboarding CTA (Sign In / Continue) and auto-navigation",
      "synonyms": [
        "smart sign-in",
        "contextual CTA"
      ],
      "description": "Final onboarding slide CTA adapts to auth state: shows Loading/Connecting, triggers login when unauthenticated, continues to /welcome when authenticated, and auto-navigates to /welcome if already authenticated on slide 3.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Welcome page with entrance animations",
      "synonyms": [
        "post-login welcome",
        "Get Started"
      ],
      "description": "Animated welcome card matching onboarding motion language; provides Get Started CTA routing to /home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Home planning dashboard with weekly strip, planning CTA, planned-moment list, and bottom navigation",
      "synonyms": [
        "HomeScreen",
        "planning-first home"
      ],
      "description": "Home shows logo header, a search input stub, a weekly calendar strip, a planning CTA (Start Planning / +), and a list of planned moments. Includes a floating bottom navigation bar that hides while the planner sheet is open.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Home weekly calendar strip with week navigation and planned-day filled pills",
      "synonyms": [
        "HomeWeeklyCalendarStrip",
        "week selector"
      ],
      "description": "Renders a Sunday-start week row with prev/next week arrows; planned dates are shown as color-filled pills using dateColorMap, and selecting a booked day uses that same planned color instead of default black styling.",
      "reqIds": [
        "REQ-2"
      ],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Home layout spacing refinement for more room for planned-moment cards",
      "synonyms": [
        "calendar strip spacing adjustment"
      ],
      "description": "Adjusts Home spacing to position the weekly calendar strip slightly higher and create more vertical space for planned-moment cards below.",
      "reqIds": [
        "REQ-3"
      ],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Planner bottom sheet for creating planned moments",
      "synonyms": [
        "PlannedMomentBottomSheet",
        "plan-a-moment"
      ],
      "description": "Slide-up bottom sheet (~75vh) with open/close animations, required time picker, optional title, native date-picker reschedule support, and save/cancel actions. Automatically assigns a deterministic date-based color when saving and keeps the sheet open on duplicate-date errors.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Planned moments local persistence (CRUD) with reactive updates",
      "synonyms": [
        "plannedMomentsStorage",
        "plannedMomentsChanged event"
      ],
      "description": "Stores planned moments in localStorage with generated IDs and createdAt timestamps; supports create, delete, load, get-by-date, date set/color map helpers, and publishes same-tab change events plus cross-tab storage subscriptions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Deterministic date→color assignment for planned moments",
      "synonyms": [
        "getColorForDate",
        "pastel OKLCH palette"
      ],
      "description": "Uses a muted OKLCH palette and a deterministic hash of ISO date strings to consistently map each date to a color across sessions (used in calendar strip and plan styling).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "One planned moment per day enforcement",
      "synonyms": [
        "duplicate-date prevention",
        "one-per-day rule"
      ],
      "description": "savePlannedMoment rejects saving another plan on the same ISO date with a 'duplicate-date' error; UI surfaces a friendly toast and keeps the bottom sheet open.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Planned moment pill card UI with share/delete actions",
      "synonyms": [
        "PlannedMomentCard",
        "pill card"
      ],
      "description": "Renders planned moments as pill-shaped transparent cards with a thin border colored by the moment/date color, a left color dot with a black ring, and in-card share + trash actions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Clipboard-based planned moment sharing",
      "synonyms": [
        "copy share text",
        "plannedMomentShareText"
      ],
      "description": "Generates formatted share text for planned moments (date/time/title + optional profile display name) and copies it to clipboard using Clipboard API with textarea/document.execCommand fallback; shows toast feedback.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "Planned moment deletion with confirmation modal",
      "synonyms": [
        "ConfirmDeleteModal",
        "delete confirm"
      ],
      "description": "Provides an in-app confirm/cancel modal before deleting a planned moment from localStorage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "Inline toast notifications",
      "synonyms": [
        "InlineToast",
        "in-app feedback"
      ],
      "description": "Reusable toast with auto-dismiss and fade/slide transitions; supports bottom or side placement for feedback such as copy success or duplicate-date warnings.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Calendar page weekly view with planned/photo indicators and planner integration",
      "synonyms": [
        "CalendarPage",
        "weekly strip"
      ],
      "description": "Displays a weekly date strip with week and month navigation; indicates planned moments and photo moments by checking local storage; opens the planner bottom sheet on date selection and supports rescheduling via native date picker.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Browser camera hook (stream lifecycle + capture)",
      "synonyms": [
        "useCamera",
        "getUserMedia management"
      ],
      "description": "Encapsulates camera support detection, getUserMedia constraints, stream cleanup, facing-mode switching, retry, and photo capture via canvas→Blob→File with configurable quality/format.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Camera capture/review flow with gallery upload",
      "synonyms": [
        "CameraScreen",
        "capture then confirm"
      ],
      "description": "Provides live preview, capture/retake, switch camera, optional gallery upload, and advances to the save confirmation screen after storing a session draft of the captured image.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "Session draft storage for camera → confirm → feeling flow",
      "synonyms": [
        "pendingMomentDraftStorage",
        "sessionStorage drafts"
      ],
      "description": "Stores captured photo draft, confirmation inputs, and the saved moment ID in sessionStorage; supports clearing draft on retake/completion.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Save moment confirmation screen (who + reflection)",
      "synonyms": [
        "SaveMomentConfirmPage",
        "post-capture confirmation"
      ],
      "description": "Shows captured photo, allows selecting who and entering an optional reflection, saves the moment to localStorage, stores the moment ID for follow-up, and routes to the feeling check screen.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Post-save feeling check-in for a moment",
      "synonyms": [
        "MomentFeelingCheckPage",
        "emotional check-in"
      ],
      "description": "Prompts “How did this feel?” with Meaningful/Good/Okay options, updates the saved moment record with the selected feeling, clears the session draft, then routes back to /home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Local photo moments storage utilities",
      "synonyms": [
        "momentsPhotosStorage",
        "local photo registry"
      ],
      "description": "Stores photo moments in localStorage (id, data URL, timestamp, MIME type, who, reflection, feeling) and provides load/update/get-by-id helpers; emits a same-tab update event on writes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Photo moments hook with reactive refresh",
      "synonyms": [
        "useMomentsPhotos",
        "storage/event listeners"
      ],
      "description": "Loads all photo moments and the most recent photo, refreshing on storage events filtered by key and a custom moments_photos_updated event for same-tab updates.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Vault gallery grouped by month with animated thumbnail grid",
      "synonyms": [
        "VaultPage",
        "memory vault"
      ],
      "description": "Groups photo moments by month/year, shows a 3-column thumbnail grid (limited to 6 per month) with entrance animations and optional feeling badges; navigates to per-moment view.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "Vault moment detail viewer with metadata overlay",
      "synonyms": [
        "VaultMomentPage",
        "full-screen viewer"
      ],
      "description": "Full-screen moment viewer with close/back control and bottom gradient overlay showing relative time, who, reflection, and feeling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "IntersectionObserver in-view hook",
      "synonyms": [
        "useInView",
        "viewport detection"
      ],
      "description": "Reusable hook to detect when elements enter the viewport with configurable threshold/rootMargin and trigger-once behavior (used for Vault animations).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Relative time formatting utility",
      "synonyms": [
        "formatRelativeTime",
        "timestamp labels"
      ],
      "description": "Formats timestamps into compact relative labels (seconds/minutes/hours/days) and falls back to a short date for older moments.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "Local-first profile storage with invite code generation",
      "synonyms": [
        "profileStorage",
        "invite code"
      ],
      "description": "Stores user profile data in localStorage, ensures an invite code exists (generating one if missing), and emits a profile_updated event on save.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "Auto-geolocation hook (once per session)",
      "synonyms": [
        "useAutoGeolocation",
        "session-gated geolocation"
      ],
      "description": "Requests browser geolocation at most once per session when profile location/coordinates are missing; calls onSuccess with coordinates on grant and logs errors without throwing.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Profile state hook with reactive updates",
      "synonyms": [
        "useProfile",
        "profile adapter"
      ],
      "description": "Manages profile state, persists updates to localStorage, auto-requests geolocation when needed, and refreshes on storage/profile_updated events.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Profile management screen",
      "synonyms": [
        "ProfilePage",
        "edit profile"
      ],
      "description": "Edits display name/location, supports profile photo upload (FileReader→data URL), copies invite code to clipboard with fallback, shows toast feedback, and navigates to Settings or Home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-38",
      "title": "Settings screen with logout",
      "synonyms": [
        "SettingsPage",
        "sign out"
      ],
      "description": "Settings UI with grouped placeholder items and a logout action that clears Internet Identity state and routes to the splash screen (/).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-39",
      "title": "Backend RBAC with admin bootstrap secret",
      "synonyms": [
        "AccessControl",
        "MixinAuthorization",
        "roles"
      ],
      "description": "Motoko RBAC supports roles (#admin/#user/#guest), initialization via env var CAFFEINE_ADMIN_TOKEN plus a user-provided token, admin-only role assignment, and endpoints to query caller role/admin status.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-40",
      "title": "Backend user profile API with authorization checks",
      "synonyms": [
        "getCallerUserProfile",
        "saveCallerUserProfile",
        "getUserProfile"
      ],
      "description": "Stores user profiles keyed by Principal; authenticated users can read/save their own profile and admins can read other users’ profiles.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-41",
      "title": "Backend user settings API with authorization checks",
      "synonyms": [
        "getCallerSettings",
        "saveCallerSettings"
      ],
      "description": "Stores per-user settings keyed by Principal; requires authenticated user role for read/write.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-42",
      "title": "Backend photo metadata registry per user (index only)",
      "synonyms": [
        "storePhoto metadata",
        "getCallerMomentsPhotos",
        "deletePhoto"
      ],
      "description": "Maintains a per-user list of photo metadata records (id/owner/timestamp/blobId) with authenticated store/list and owner-only delete behavior; blob persistence is not yet implemented.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-43",
      "title": "Backend blob-storage maintenance and authorization endpoints (mixin)",
      "synonyms": [
        "MixinStorage",
        "gateway allowlist",
        "cycles refill"
      ],
      "description": "Exposes endpoints to update authorized gateway principals, check blob liveness, list dead blobs for deletion (authorized callers), confirm deletion + trigger GC, create an upload certificate stub, and refill cycles via a cashier principal.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-44",
      "title": "Reserved module for future backend query hooks",
      "synonyms": [
        "useQueries placeholder"
      ],
      "description": "Placeholder file reserved for future React Query hooks that interact with the backend; currently exports nothing.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-redesign-the-vault-overview-gallery-vaultpage-so-photo-cards-thumbnails-are-significantly-larger-on-mobile-and-no-longer-feel-cramped-e-g-fewer-columns-larger-tile-sizes-improved-spacing-and-clearer-hierarchy-between-month-header-and-grid",
      "title": "Redesign the Vault overview gallery (VaultPage) so photo cards/thumbnails are significantly larger on mobile and no longer feel cramped (e.g., fewer columns, larger tile sizes, improved spacing, and clearer hierarchy between month header and grid).",
      "reqIds": [
        "REQ-4"
      ],
      "version": 1
    },
    {
      "id": "feature-improve-the-visual-styling-of-vault-overview-cards-tiles-to-feel-more-premium-and-intentional-refine-surface-treatment-borders-shadows-corner-radius-and-typography-consistency-while-keeping-the-current-app-s-warm-beige-baseline-background",
      "title": "Improve the visual styling of Vault overview cards/tiles to feel more premium and intentional (refine surface treatment, borders/shadows, corner radius, and typography consistency) while keeping the current app’s warm/beige baseline background.",
      "reqIds": [
        "REQ-5"
      ],
      "version": 1
    },
    {
      "id": "feature-add-richer-motion-to-the-vault-experience-smoother-entrance-animations-for-month-sections-and-tiles-improved-tap-press-feedback-on-tiles-and-a-more-polished-transition-feel-when-navigating-into-and-out-of-the-moment-viewer-vaultmomentpage",
      "title": "Add richer motion to the Vault experience: smoother entrance animations for month sections and tiles, improved tap/press feedback on tiles, and a more polished transition feel when navigating into and out of the moment viewer (VaultMomentPage).",
      "reqIds": [
        "REQ-6"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Revamp Vault UI: increase card/photo sizes, improve visual styling, and add smooth motion/animations for a more premium feel.",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Frontend is a React + TypeScript SPA using TanStack Router for navigation and TanStack React Query for shared caching (notably backend actor caching keyed by principal).",
    "UI is mobile-first and consistently rendered inside a centered phone-sized viewport (max ~390×844) over a full-screen backdrop to preserve a mobile layout on desktop.",
    "Styling uses Tailwind utilities plus extensive custom CSS (OKLCH design tokens, custom animations for onboarding, bottom sheets, modals, and toasts).",
    "Local-first persistence: planned moments, photo moments, and profile are stored in localStorage; the capture flow uses sessionStorage for draft state between screens.",
    "Same-tab data reactivity is implemented via custom DOM events (e.g., plannedMomentsChanged, moments_photos_updated, profile_updated) in addition to the browser storage event for cross-tab updates.",
    "Authentication is provided via a custom Internet Identity context/provider built on AuthClient; actor creation is identity-aware and initialized with an admin secret read from the URL hash (scrubbed after extraction).",
    "Backend is a Motoko canister composed via mixins (authorization + blob-storage maintenance endpoints). RBAC is first-user-admin bootstrapped via env var CAFFEINE_ADMIN_TOKEN and a user-provided secret."
  ],
  "known_issues": [
    "Two global CSS entrypoints exist (frontend/index.css and frontend/src/index.css). The app imports frontend/src/index.css via src/main.tsx; the other file can drift and cause confusion.",
    "frontend/src/components/HamburgerMenu.tsx is empty (placeholder).",
    "frontend/src/components/SignInOverlay.tsx is empty (placeholder).",
    "frontend/src/pages/MomentsPage.tsx is empty/unimplemented.",
    "frontend/src/pages/MomentFeelingCheckPage.tsx navigates via setTimeout without cleanup; navigation could fire after unmount in edge cases.",
    "CalendarPage reads localStorage('moments_photos') into a PhotoMetadata shape containing dataUrl, but momentsPhotosStorage persists the image under data; currently CalendarPage only uses timestamp so the mismatch is latent but confusing.",
    "CameraScreen does not revoke the captured blob URL after proceeding to the next screen (only on retake), potentially leaking memory until reload.",
    "CameraScreen flash toggle is UI-only; the camera hook does not implement torch/flash control.",
    "Backend storePhoto does not persist the provided Blob into blob storage (comment indicates missing put call) and sets metadata timestamp to 0.",
    "backend/main.mo getBlob is a placeholder that always returns null.",
    "Backend canister state (maps/counters/roles) is not stable; data will be lost on upgrade without stable variables and preupgrade/postupgrade handling.",
    "backend/blob-storage/Storage.mo references env var CAFFFEINE_STORAGE_CASHIER_PRINCIPAL (likely misspelled), increasing deployment misconfiguration risk.",
    "backend/blob-storage/Storage.mo refillCashier computes Nat.sub(currentBalance, reservedCycles); if currentBalance < reservedCycles this can trap due to Nat underflow.",
    "authorization/access-control.mo traps for unregistered users in getUserRole; callers must ensure initialization occurs for new principals before permission checks."
  ],
  "isFixRequest": false,
  "gameProjectType": "none",
  "projectName": "Moments",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}