{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 3,
  "summary": "Moments is a mobile-first React single-page app for planning real-life activities (“planned moments”) and capturing private photo memories (“moments”). The UX centers on a 3-slide animated onboarding/splash experience with Internet Identity sign-in, a Welcome screen, then a planning-first Home. Users can plan moments via a weekly calendar and a bottom-sheet planner (time/title/with-who), and capture photo moments using an in-app camera flow (capture/upload → confirm who/reflection → optional feeling check). Captured moments are stored locally and browsed in a Vault gallery and per-moment viewer. The repository also includes a Motoko backend canister with role-based access control (admin bootstrap via env token), profile/settings endpoints, and a per-user photo metadata registry plus blob-storage maintenance mixins (blob get/put integration is currently incomplete).",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Client-side routing across app screens",
      "synonyms": [
        "TanStack Router routes",
        "SPA navigation"
      ],
      "description": "Defines routes for splash (/), welcome (/welcome), home (/home), camera (/camera), save confirmation (/save-moment), feeling check (/feeling-check), calendar (/calendar), vault (/vault), vault detail (/vault/$momentId), profile (/profile), and settings (/settings).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Animated onboarding splash slideshow (3 cards)",
      "synonyms": [
        "Onboarding carousel",
        "Splash cards"
      ],
      "description": "Implements a 3-slide onboarding experience with per-slide theming, mixed media (video on slide 1, images on slides 2–3), timed auto-advance, manual Prev/Next controls, and direction-aware 3D card transitions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Splash media preloading for fast onboarding",
      "synonyms": [
        "Preload splash assets"
      ],
      "description": "Preloads the splash video and images via `<link rel=\"preload\">` in `frontend/index.html` for faster first render and smoother transitions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Internet Identity authentication context and hook",
      "synonyms": [
        "InternetIdentityProvider",
        "AuthClient integration"
      ],
      "description": "Provides a React context and `useInternetIdentity` hook that initializes DFINITY AuthClient, loads any persisted delegation identity, exposes identity + login status flags, and supports login/logout (clear).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Auth-aware splash CTA (sign-in vs continue) and post-login routing",
      "synonyms": [
        "Smart Sign In button",
        "Authenticated continue"
      ],
      "description": "On the third splash slide, shows contextual CTA text (Loading/Connecting/Continue/Sign In). If already authenticated, routes to /welcome; otherwise triggers the Internet Identity login flow.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Backend canister actor creation and caching keyed by principal",
      "synonyms": [
        "useActor",
        "React Query actor cache"
      ],
      "description": "Creates an authenticated or anonymous backend actor via `createActorWithConfig`, caches it with React Query under a principal-based key, initializes RBAC with `_initializeAccessControlWithSecret`, and invalidates/refetches dependent queries when the actor changes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Secret parameter handling via URL hash + session persistence",
      "synonyms": [
        "Admin token in hash",
        "URL secret extraction"
      ],
      "description": "Utilities (`urlParams.ts`) read parameters from query/hash, persist to sessionStorage, and remove sensitive hash params from the URL via `history.replaceState`; used for secrets such as `caffeineAdminToken`.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Welcome screen with entrance animations and Get Started CTA",
      "synonyms": [
        "Post-login welcome page"
      ],
      "description": "Renders a stylized Welcome card with coordinated 3D entrance/text animations and a Get Started button that navigates to /home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "Planning-first Home screen with fixed mobile viewport and footer navigation",
      "synonyms": [
        "Home dashboard",
        "Mobile-centered layout"
      ],
      "description": "Home renders a logo header, a search bar UI, a weekly calendar strip component, and a planning promo card, plus a curved floating footer nav for Home/Calendar/Camera/Vault/Profile.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Home planning CTA button text set to “Start Planning”",
      "synonyms": [
        "Home calendar CTA rename"
      ],
      "description": "Updates the Home screen planning CTA button label from “View Full Calendar” to “Start Planning”.",
      "reqIds": [
        "REQ-6"
      ],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Home weekly calendar header label set to “Moment Month”",
      "synonyms": [
        "Home strip label rename"
      ],
      "description": "Updates the Home weekly calendar strip header label text from “Reschedule” to “Moment Month”.",
      "reqIds": [
        "REQ-7"
      ],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Home weekly calendar strip component",
      "synonyms": [
        "Single-row week strip"
      ],
      "description": "Reusable Home component showing a navigable week row (Sun–Sat) with previous/next week arrows, centered month title, and selectable date styling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Calendar page weekly view with month/week navigation and date selection",
      "synonyms": [
        "CalendarPage",
        "Week strip calendar"
      ],
      "description": "Implements a weekly calendar strip with month navigation, week navigation, horizontal scrolling, selectable dates, and dot/ring indicators for planned moments and stored photo moments; tapping a date opens the planning bottom sheet.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Planned moment creation bottom sheet (time steppers + with-who pills)",
      "synonyms": [
        "PlannedMomentBottomSheet",
        "Plan a Moment sheet"
      ],
      "description": "Bottom sheet UI to plan a moment with hour/minute steppers and numeric inputs, optional title, required with-who selection (Family/Friends/Partner/Solo/Custom), and Save/Cancel actions with open/close animations.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Planned moments local persistence and derived per-date color mapping",
      "synonyms": [
        "plannedMomentsStorage",
        "usePlannedMoments"
      ],
      "description": "Stores planned moments in localStorage and supports querying by date; derives `datesWithMoments` and a deterministic per-date color map (earliest-by-time moment determines date color) for calendar indicators.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Camera hook abstraction for getUserMedia lifecycle and capture",
      "synonyms": [
        "useCamera",
        "Camera stream management"
      ],
      "description": "Encapsulates camera support detection, MediaStream lifecycle cleanup, facing-mode switching, retry handling, and photo capture via canvas-to-blob with categorized errors (permission/not-supported/not-found/unknown).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Camera screen: capture or upload, review, then continue",
      "synonyms": [
        "CameraScreen",
        "Capture flow"
      ],
      "description": "Full-screen camera UI that starts live preview, captures photos, supports retake and camera switching, allows gallery upload, and proceeds to save confirmation by converting the capture to base64 and storing a session draft.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Session-based draft storage for capture → confirm → feeling flow",
      "synonyms": [
        "pendingMomentDraftStorage",
        "Session draft persistence"
      ],
      "description": "Stores capture draft data (base64/type/timestamp), confirmation inputs, and the saved moment ID in sessionStorage; supports clearing all draft state when complete or retaking.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Save moment confirmation screen (who + reflection)",
      "synonyms": [
        "SaveMomentConfirmPage",
        "Post-capture confirmation"
      ],
      "description": "Shows captured photo preview and prompts for “who was this with?” plus an optional reflection; saves the moment to localStorage and routes to the feeling check step; supports retake.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "Post-save feeling check-in for a moment",
      "synonyms": [
        "MomentFeelingCheckPage",
        "Emotional check-in"
      ],
      "description": "Prompts for one of three feelings (Meaningful/Good/Okay), updates the stored moment record, clears session draft state, and navigates back to /home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "Local moments photo storage utilities (CRUD) with update events",
      "synonyms": [
        "momentsPhotosStorage",
        "Local moments library"
      ],
      "description": "Implements localStorage persistence for captured photo moments including who/reflection/feeling fields, plus helpers to load/save/update/get by ID and dispatches `moments_photos_updated` for same-tab updates.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Moments photos React hook with storage and event listeners",
      "synonyms": [
        "useMomentsPhotos"
      ],
      "description": "Loads moments from localStorage and keeps state synced via the `storage` event (cross-tab) and `moments_photos_updated` (same-tab), exposing all photos and the most recent moment.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Vault gallery grouped by month with animated thumbnail grid",
      "synonyms": [
        "VaultPage",
        "Memory vault grid"
      ],
      "description": "Loads saved moments, sorts by recency, groups by month/year, and renders a 3-column thumbnail grid with scroll-triggered entrance animations; thumbnails can show an optional feeling icon overlay.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Vault moment detail viewer with metadata overlay",
      "synonyms": [
        "VaultMomentPage",
        "Full-screen moment view"
      ],
      "description": "Displays a single moment full-screen with a close/back control, contained image scaling, and a bottom gradient overlay showing relative time, who/reflection, and feeling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "IntersectionObserver in-view hook for scroll-triggered animations",
      "synonyms": [
        "useInView"
      ],
      "description": "Reusable hook wrapping IntersectionObserver to detect when an element enters the viewport with configurable threshold/rootMargin and trigger-once behavior.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Local-first profile storage with invite code and update events",
      "synonyms": [
        "profileStorage",
        "Invite code generation"
      ],
      "description": "Stores user profile data in localStorage (picture/name/location/coordinates) and ensures an invite code exists; emits `profile_updated` for same-tab synchronization.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Profile hook with auto-geolocation",
      "synonyms": [
        "useProfile",
        "useAutoGeolocation"
      ],
      "description": "Manages profile state, listens for profile updates, and auto-requests browser geolocation once per session when location/coordinates are missing; persists formatted coordinates into profile storage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Profile management screen (edit fields, upload photo, copy invite code)",
      "synonyms": [
        "ProfilePage"
      ],
      "description": "UI to edit display name/location, upload a profile photo, copy invite code to clipboard (with fallback), show inline toast feedback, and navigate to settings or home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Inline toast feedback component",
      "synonyms": [
        "InlineToast"
      ],
      "description": "Reusable fixed-position toast with auto-dismiss and fade-out transition used for lightweight confirmations (e.g., profile saved, invite code copied).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Settings screen with logout",
      "synonyms": [
        "SettingsPage",
        "Sign out"
      ],
      "description": "Renders a grouped settings UI and supports logout by clearing Internet Identity state and routing back to splash (/).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "Design system: Tailwind + OKLCH tokens, glassmorphic surfaces, and custom animations",
      "synonyms": [
        "Global styling",
        "Custom CSS animations"
      ],
      "description": "Defines OKLCH-based theme tokens, glass-card styling, home/calendar/vault/bottom-sheet styles, and bespoke animations for splash/welcome/vault; includes a global pulse animation on buttons with `.no-pulse` opt-out.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "Backend role-based access control (RBAC) with admin bootstrap secret",
      "synonyms": [
        "AccessControl",
        "MixinAuthorization"
      ],
      "description": "Motoko RBAC supports roles (#admin/#user/#guest), initialization using an environment secret (`CAFFEINE_ADMIN_TOKEN`) plus user-provided token, admin role assignment, and endpoints to query caller role/admin status.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Backend user profile API with authorization checks",
      "synonyms": [
        "getCallerUserProfile",
        "saveCallerUserProfile",
        "getUserProfile"
      ],
      "description": "Motoko canister stores user profiles keyed by Principal; authenticated users can read/save their own profile; admins can read other users’ profiles.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "Backend user settings API with authorization checks",
      "synonyms": [
        "getCallerSettings",
        "saveCallerSettings"
      ],
      "description": "Stores per-user settings keyed by Principal; requires authenticated user role for read/write.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "Backend moments photo metadata registry (per-user index)",
      "synonyms": [
        "storePhoto metadata",
        "getCallerMomentsPhotos",
        "deletePhoto"
      ],
      "description": "Maintains a per-user list of photo metadata records (id/owner/timestamp/blobId) with authenticated store/list and owner-only delete behavior; blob storage integration is intended but incomplete.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Backend blob-storage maintenance mixin endpoints",
      "synonyms": [
        "MixinStorage",
        "Gateway principal updates",
        "Cycles refill",
        "Dead blob pruning"
      ],
      "description": "Includes endpoints to update authorized gateway principals, check blob liveness, list dead blobs for deletion (authorized callers), confirm pruning and trigger GC, create an upload certificate response, and refill cycles via the cashier principal.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Reserved module for future React Query backend hooks",
      "synonyms": [
        "useQueries placeholder"
      ],
      "description": "A placeholder `useQueries.ts` module reserved for future React Query hooks; currently exports nothing because some flows do not require backend queries.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-update-the-home-screen-so-that-a-clicking-a-date-in-the-home-weekly-calendar-strip-and-b-clicking-the-start-planning-cta-both-open-the-planned-moment-slide-up-bottom-sheet-same-interaction-pattern-as-the-calendar-page-instead-of-navigating-away-the-bottom-sheet-must-use-the-clicked-selected-date-and-closing-the-sheet-must-return-the-user-to-the-home-screen-without-route-changes",
      "title": "Update the Home screen so that (a) clicking a date in the Home weekly calendar strip and (b) clicking the “Start Planning” CTA both open the planned-moment slide-up bottom sheet (same interaction pattern as the Calendar page) instead of navigating away. The bottom sheet must use the clicked/selected date, and closing the sheet must return the user to the Home screen without route changes.",
      "reqIds": [
        "REQ-8"
      ],
      "version": 1
    },
    {
      "id": "feature-redesign-the-planned-moment-bottom-sheet-ui-reference-uploaded-image-image-45-png-to-improve-the-date-time-setup-and-remove-the-undesirable-pulsating-button-behavior-replace-the-current-time-stepper-controls-with-a-cleaner-time-selection-ui-e-g-a-compact-time-input-picker-and-use-clear-icons-where-appropriate-keep-the-with-who-selector-simple-still-icon-based-and-ensure-all-buttons-in-this-bottom-sheet-do-not-pulse",
      "title": "Redesign the Planned Moment bottom sheet UI (reference: uploaded image image-45.png) to improve the date/time setup and remove the undesirable pulsating button behavior. Replace the current time stepper (+/-) controls with a cleaner time selection UI (e.g., a compact time input/picker) and use clear icons where appropriate. Keep the “With who?” selector simple (still icon-based) and ensure all buttons in this bottom sheet do not pulse.",
      "reqIds": [
        "REQ-9"
      ],
      "version": 1
    },
    {
      "id": "feature-ensure-planned-moments-reliably-appear-on-the-exact-chosen-day-and-are-color-coded-in-the-home-weekly-calendar-strip-and-remain-consistent-with-calendar-page-behavior-the-day-indicator-must-update-immediately-after-saving-a-planned-moment-and-the-chosen-day-must-reflect-the-color-associated-with-the-saved-moment-s-category",
      "title": "Ensure planned moments reliably appear on the exact chosen day and are color-coded in the Home weekly calendar strip (and remain consistent with Calendar page behavior). The day indicator must update immediately after saving a planned moment, and the chosen day must reflect the color associated with the saved moment’s category.",
      "reqIds": [
        "REQ-10"
      ],
      "version": 1
    },
    {
      "id": "feature-fix-planned-moment-ui-updates-across-components-by-making-planned-moment-storage-changes-observable-when-a-planned-moment-is-saved-any-ui-that-depends-on-planned-moments-home-weekly-strip-indicators-calendar-page-indicators-and-any-planned-moment-lists-must-refresh-from-storage-automatically",
      "title": "Fix planned-moment UI updates across components by making planned-moment storage changes observable. When a planned moment is saved, any UI that depends on planned moments (Home weekly strip indicators, Calendar page indicators, and any planned-moment lists) must refresh from storage automatically.",
      "reqIds": [
        "REQ-11"
      ],
      "version": 1
    },
    {
      "id": "feature-adjust-the-global-pulsating-button-behavior-so-the-app-does-not-pulse-most-buttons-by-default-pulsing-should-be-opt-in-e-g-only-for-the-camera-button-if-still-desired-and-existing-critical-ctas-should-remain-visually-strong-without-animation-reliance",
      "title": "Adjust the global pulsating button behavior so the app does not pulse most buttons by default. Pulsing should be opt-in (e.g., only for the camera button if still desired), and existing critical CTAs should remain visually strong without animation reliance.",
      "reqIds": [
        "REQ-12"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Onboarding splash slideshow: 3 themed cards + welcome slide with GSAP transitions, progress dots, and Prev/Next navigation",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-2",
      "summary": "Step-by-step navigation flow: Slide 1→2→3 (Sign In)→Welcome→Discover/Home; remove forced /welcome redirect; always start at slide 1",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-3",
      "summary": "Home redesign to be planning-first (no Vault photos): header + primary planning container + single-row weekly calendar labeled “Moment Month” + Start Planning CTA",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-4",
      "summary": "Plan-a-moment bottom sheet from Home (date click or Start Planning): improved UI for date/time + simple “with who” selector; save/cancel buttons; saved plans appear color-coded on the chosen date and listed below calendar",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-5",
      "summary": "Vault UX improvements: square photo grid with motion; tap opens enlarged clear viewer; keep Vault content isolated from Home/calendar surfaces",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-6",
      "summary": "Automatic browser geolocation (permission-based) to fetch and display user location by default (profile/home)",
      "reqIds": [],
      "status": "in_progress"
    }
  ],
  "architectural_notes": [
    "Frontend is a React SPA using TanStack Router for route definitions and navigation between full-screen “mobile viewport” pages.",
    "State and persistence are local-first: planned moments and photo moments are stored in localStorage; in-progress capture/confirm state is stored in sessionStorage.",
    "Cross-component/tab synchronization uses browser `storage` events plus custom same-tab DOM events (`moments_photos_updated`, `profile_updated`).",
    "Authentication is encapsulated in a React context/provider (`InternetIdentityProvider`) built on DFINITY AuthClient, exposing identity and detailed login status flags.",
    "Backend access is encapsulated by a `useActor` hook that creates an authenticated/anonymous canister actor via React Query, keyed by principal, and initializes backend RBAC using a secret from the URL hash/session.",
    "UI styling uses Tailwind plus extensive custom CSS (OKLCH design tokens, glassmorphism, and bespoke animations for splash/welcome/vault/bottom-sheet).",
    "Backend is a Motoko canister composed with mixins: authorization (RBAC) and blob-storage maintenance (gateway principal updates, dead-blob pruning, cycles refill, and certificate creation).",
    "Home page must not query or render Vault photo content; Home calendar is planning-only.",
    "Planned moments should persist locally and include a stable relationship-derived color; calendar date rendering should circle/mark dates based on planned moments only.",
    "Navigation should avoid forced direct route redirects (e.g., hard redirect to /welcome) and preserve the intended sequential onboarding/auth flow."
  ],
  "known_issues": [
    "Backend `storePhoto` does not actually persist the blob (comment indicates the storage put call is missing) and stores `timestamp = 0`; `getBlob` is a hardcoded `null` placeholder.",
    "Blob-storage env var name appears typo-prone: `CAFFFEINE_STORAGE_CASHIER_PRINCIPAL` (triple ‘F’) may not match intended configuration.",
    "RBAC `getUserRole` traps with \"User is not registered\" until `_initializeAccessControlWithSecret` has been called for that principal; this can break authenticated calls if initialization is skipped.",
    "`frontend/src/components/HamburgerMenu.tsx` and `frontend/src/components/SignInOverlay.tsx` exist but are empty placeholders (despite external summaries claiming implementations).",
    "`frontend/src/pages/MomentsPage.tsx` exists but is empty/unimplemented.",
    "Two global CSS entrypoints exist (`frontend/index.css` and `frontend/src/index.css`); the app imports `frontend/src/index.css`, so the other file may cause confusion or drift.",
    "Global CSS applies a pulse animation to nearly all enabled `<button>` elements by default; many components must opt out via `.no-pulse`, which can be easy to miss and may harm UX/accessibility.",
    "`CalendarPage` defines a `PhotoMetadata` type with `dataUrl`, but stored moments use `data`; current logic only relies on `timestamp`, so the model/types are inconsistent.",
    "Camera flow sets an `isFlashOn` UI state, but there is no actual flash/torch control implementation.",
    "Planned-moment color coding is not reliably applied (e.g., family plan not coloring/circling the allocated date after save).",
    "Home calendar UI regressed at times (wrong styling: emojis/blue accents/size; should match single-row weekly reference exactly).",
    "Planning bottom-sheet UI/controls need refinement (current date/time setup disliked; pulsating buttons considered undesirable).",
    "Deployments intermittently fail/redeploy fails, blocking iteration."
  ],
  "isFixRequest": true,
  "gameProjectType": "none",
  "projectName": "Moments",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}