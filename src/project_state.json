{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 3,
  "summary": "Moments is a mobile-first React + TypeScript SPA focused on a calm, minimal, planning-first flow (single-row weekly calendar on Home + slide-up planner) and a private capture-to-save Moments flow (camera → confirm → feeling check) with a Vault for viewing saved photo moments. The app integrates Dfinity Internet Identity for authentication, uses local-first persistence, and is being refactored to avoid social-media-like feeds, emphasizing planning and quiet memory keeping.",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Client-side routing across app screens",
      "synonyms": [
        "TanStack Router",
        "SPA navigation"
      ],
      "description": "Defines routes for splash (/), welcome (/welcome), home (/home), camera (/camera), save moment confirmation (/save-moment), feeling check (/feeling-check), calendar (/calendar), vault (/vault), vault detail (/vault/$momentId), profile (/profile), and settings (/settings).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "React Query provider setup",
      "synonyms": [
        "QueryClientProvider",
        "TanStack React Query"
      ],
      "description": "Initializes a shared QueryClient and wraps the app to enable cached queries and shared query invalidation patterns.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Internet Identity authentication provider and hook",
      "synonyms": [
        "AuthClient integration",
        "InternetIdentityProvider"
      ],
      "description": "Manages identity hydration on mount, login/logout, and exposes granular status flags (initializing/idle/logging-in/success/loginError) plus error state.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Backend actor creation and caching per principal",
      "synonyms": [
        "useActor",
        "authenticated actor"
      ],
      "description": "Creates anonymous or authenticated backend actors depending on Internet Identity state, caches them with React Query keyed by principal, and triggers access-control initialization using a secret token.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Secure-ish URL hash secret extraction with session persistence",
      "synonyms": [
        "getSecretParameter",
        "URL hash scrubbing"
      ],
      "description": "Utilities to extract sensitive parameters from the URL hash, persist them in sessionStorage, and scrub them from the address bar via history.replaceState.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Mobile-first fixed viewport frame layout",
      "synonyms": [
        "390×844 container",
        "phone frame UI"
      ],
      "description": "Most pages render inside a fixed full-screen backdrop with a centered viewport constrained to typical mobile dimensions for consistent design on desktop and mobile.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Animated onboarding splash slideshow (3 slides)",
      "synonyms": [
        "onboarding carousel",
        "3D transitions"
      ],
      "description": "Implements a 3-slide onboarding experience with long-duration 3D enter/exit transitions, autoplay progression, and Prev/Next navigation controls.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Splash cards support video and image media",
      "synonyms": [
        "mixed media slides",
        "autoplay video slide"
      ],
      "description": "Splash cards can render an autoplaying, muted looping video (playsInline) or eager-loaded images with slide-specific layout tweaks.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "Auth-aware onboarding CTA (Sign In / Continue)",
      "synonyms": [
        "smart sign-in",
        "contextual CTA"
      ],
      "description": "On the final onboarding slide, CTA text and behavior adapt to auth state: shows Loading/Connecting, triggers login when unauthenticated, and continues to /welcome when authenticated.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Welcome page with entrance animations",
      "synonyms": [
        "post-login welcome",
        "Get Started"
      ],
      "description": "Animated welcome card matching onboarding motion language; provides Get Started CTA routing to /home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Home planning screen (weekly strip + planner entry)",
      "synonyms": [
        "HomeScreen",
        "planning-first home"
      ],
      "description": "Home shows logo header, search bar stub, a weekly calendar strip, a planning container CTA, and a list of saved planned moments. Includes a floating bottom navigation bar and hides it while the planner sheet is open.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Home weekly calendar strip with week navigation and planned-day fill colors",
      "synonyms": [
        "HomeWeeklyCalendarStrip",
        "week selector"
      ],
      "description": "Renders a Sunday-start week row with prev/next week arrows; planned dates are shown as color-filled pills based on dateColorMap; selected date is shown as a black pill.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Planner bottom sheet for creating planned moments",
      "synonyms": [
        "PlannedMomentBottomSheet",
        "plan-a-moment"
      ],
      "description": "Slide-up bottom sheet (~75vh) with open/close animations, required time picker, optional title, native date-picker reschedule support, and save/cancel actions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Planned moments local persistence (CRUD) with reactive updates",
      "synonyms": [
        "plannedMomentsStorage",
        "plannedMomentsChanged event"
      ],
      "description": "Stores planned moments in localStorage with generated IDs and createdAt timestamps; supports create, delete, load, get-by-date, and publishes same-tab change events plus filtered cross-tab storage subscriptions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Deterministic date→color assignment for planned moments",
      "synonyms": [
        "getColorForDate",
        "pastel OKLCH palette"
      ],
      "description": "Uses a muted OKLCH palette and a deterministic hash of ISO date strings to consistently map each date to a color across sessions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "One planned moment per day enforcement",
      "synonyms": [
        "duplicate-date prevention",
        "one-per-day rule"
      ],
      "description": "savePlannedMoment rejects saving another plan on the same ISO date with a 'duplicate-date' error; UI surfaces a friendly toast and keeps the bottom sheet open.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Planned moment card UI (transparent pill border-only) with actions",
      "synonyms": [
        "PlannedMomentCard",
        "reference-matched layout"
      ],
      "description": "Renders planned moments as pill-shaped, fully transparent cards with a thin border colored to the moment/date color, a left color dot with a black ring, and right-side vertically stacked share + trash icons (Font Awesome).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Clipboard-based planned moment sharing",
      "synonyms": [
        "copy share text",
        "plannedMomentShareText"
      ],
      "description": "Generates formatted share text (date/time/title + optional profile display name) and copies it to clipboard using Clipboard API with textarea/document.execCommand fallback; shows toast feedback.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Planned moment deletion with confirmation modal",
      "synonyms": [
        "ConfirmDeleteModal",
        "delete confirm"
      ],
      "description": "Provides an in-app confirm/cancel modal before deleting a planned moment from localStorage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "Inline toast notifications",
      "synonyms": [
        "InlineToast",
        "in-app feedback"
      ],
      "description": "Reusable toast with auto-dismiss and fade/slide transitions; supports bottom or side placement for feedback like copy success, duplicate-date warnings, and profile saved.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "Calendar page weekly view with planned/photo indicators and planner integration",
      "synonyms": [
        "CalendarPage",
        "weekly strip"
      ],
      "description": "Shows a weekly date strip with month/week navigation; indicates planned moments (ring + dot) and photo moments (dot) by checking storage; opens the planner bottom sheet on date selection and supports rescheduling via native date picker.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Browser camera hook (stream lifecycle + capture)",
      "synonyms": [
        "useCamera",
        "getUserMedia management"
      ],
      "description": "Encapsulates camera support detection, getUserMedia constraints, stream cleanup, facing-mode switching, retry, and photo capture via canvas→Blob→File with configurable quality/format.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Camera capture/review flow with gallery upload",
      "synonyms": [
        "CameraScreen",
        "capture then confirm"
      ],
      "description": "Provides live preview, capture/retake, switch camera, optional gallery upload, and advances to the save confirmation screen after storing a session draft.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Session draft storage for camera → confirm → feeling flow",
      "synonyms": [
        "pendingMomentDraftStorage",
        "sessionStorage drafts"
      ],
      "description": "Stores captured photo draft, confirmation inputs, and the saved moment ID in sessionStorage; supports clearing draft on retake/completion.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "Save moment confirmation screen (who + reflection)",
      "synonyms": [
        "SaveMomentConfirmPage",
        "post-capture confirmation"
      ],
      "description": "Shows captured photo, allows selecting who and entering an optional reflection, saves the moment to localStorage, stores the moment ID for follow-up, and routes to the feeling check screen.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Post-save feeling check-in for a moment",
      "synonyms": [
        "MomentFeelingCheckPage",
        "emotional check-in"
      ],
      "description": "Prompts “How did this feel?” with Meaningful/Good/Okay options, updates the saved moment record with the selected feeling, clears the session draft, then routes back to /home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Local photo moments storage utilities",
      "synonyms": [
        "momentsPhotosStorage",
        "local photo registry"
      ],
      "description": "Stores photo moments in localStorage (id, data URL, timestamp, MIME type, who, reflection, feeling) and provides load/update/get-by-id helpers; emits a same-tab update event on writes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Photo moments hook with reactive refresh",
      "synonyms": [
        "useMomentsPhotos",
        "storage/event listeners"
      ],
      "description": "Loads all photo moments and the most recent photo, refreshing on storage events (filtered by key) and a custom moments_photos_updated event.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Vault gallery grouped by month with animated thumbnail grid",
      "synonyms": [
        "VaultPage",
        "memory vault"
      ],
      "description": "Groups photo moments by month/year, shows a 3-column thumbnail grid (limited to 6 per month) with entrance animations and optional feeling badges; navigates to per-moment view.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Vault moment detail viewer with metadata overlay",
      "synonyms": [
        "VaultMomentPage",
        "full-screen viewer"
      ],
      "description": "Full-screen moment viewer with back control and bottom gradient overlay showing relative time, who, reflection, and feeling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "IntersectionObserver in-view hook",
      "synonyms": [
        "useInView",
        "viewport detection"
      ],
      "description": "Reusable hook to detect when elements enter the viewport with configurable threshold/rootMargin and trigger-once behavior (used for Vault section animations).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "Relative time formatting utility",
      "synonyms": [
        "formatRelativeTime",
        "timestamp labels"
      ],
      "description": "Formats timestamps into compact relative labels (seconds/minutes/hours/days) and falls back to a short date for older moments.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Local-first profile storage with invite code generation",
      "synonyms": [
        "profileStorage",
        "invite code"
      ],
      "description": "Stores user profile data in localStorage, ensures an invite code exists (generating one if missing), and emits a profile_updated event on save.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "Auto-geolocation hook (once per session)",
      "synonyms": [
        "useAutoGeolocation",
        "session-gated geolocation"
      ],
      "description": "Requests browser geolocation at most once per session when profile location/coordinates are missing; calls onSuccess with coordinates on grant and logs errors without throwing.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "Profile state hook with reactive updates",
      "synonyms": [
        "useProfile",
        "profile adapter"
      ],
      "description": "Manages profile state, persists updates to localStorage, auto-requests geolocation when needed, and refreshes on storage/profile_updated events.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Profile management screen",
      "synonyms": [
        "ProfilePage",
        "edit profile"
      ],
      "description": "Edits display name/location, supports profile photo upload (FileReader→data URL), copies invite code to clipboard with fallback, shows toast feedback, and navigates to Settings or Home.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Settings screen with logout",
      "synonyms": [
        "SettingsPage",
        "sign out"
      ],
      "description": "Settings UI with grouped placeholder items and a logout action that clears Internet Identity state and routes to the splash screen (/).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-38",
      "title": "Presentational moment image card component",
      "synonyms": [
        "MomentsImageCard",
        "moment UI card"
      ],
      "description": "Reusable presentational card for displaying a moment image with avatar/name/location/timestamp and optional who/reflection/feeling metadata (no social engagement actions).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-39",
      "title": "Reserved module for future backend query hooks",
      "synonyms": [
        "useQueries placeholder"
      ],
      "description": "Placeholder file reserved for future React Query hooks that interact with the backend; currently exports nothing.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-40",
      "title": "Backend RBAC with admin bootstrap secret",
      "synonyms": [
        "AccessControl",
        "MixinAuthorization",
        "roles"
      ],
      "description": "Motoko RBAC supports roles (#admin/#user/#guest), initialization via env var CAFFEINE_ADMIN_TOKEN plus a user-provided token, admin-only role assignment, and endpoints to query caller role/admin status.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-41",
      "title": "Backend user profile API with authorization checks",
      "synonyms": [
        "getCallerUserProfile",
        "saveCallerUserProfile",
        "getUserProfile"
      ],
      "description": "Stores user profiles keyed by Principal; authenticated users can read/save their own profile and admins can read other users’ profiles.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-42",
      "title": "Backend user settings API with authorization checks",
      "synonyms": [
        "getCallerSettings",
        "saveCallerSettings"
      ],
      "description": "Stores per-user settings keyed by Principal; requires authenticated user role for read/write.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-43",
      "title": "Backend photo metadata registry per user (index only)",
      "synonyms": [
        "storePhoto metadata",
        "getCallerMomentsPhotos",
        "deletePhoto"
      ],
      "description": "Maintains a per-user list of photo metadata records (id/owner/timestamp/blobId) with authenticated store/list and owner-only delete behavior; blob persistence is incomplete.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-44",
      "title": "Backend blob-storage maintenance and authorization endpoints (mixin)",
      "synonyms": [
        "MixinStorage",
        "gateway allowlist",
        "cycles refill"
      ],
      "description": "Exposes endpoints to update authorized gateway principals, check blob liveness, list dead blobs for deletion (authorized callers), confirm deletion + trigger GC, create an upload certificate stub, and refill cycles via a cashier principal.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-adjust-the-planned-moment-pill-card-styling-so-the-card-appears-significantly-narrower-reduced-height-thickness-and-more-elongated-horizontally-while-preserving-the-existing-border-only-pill-look-left-color-dot-and-right-side-action-icons-implement-this-by-updating-the-css-for-the-planned-moment-card-classes-used-by-frontend-src-components-plannedmomentcard-tsx-e-g-planned-moment-card-clear-planned-moment-card-color-dot-and-related-action-icon-sizing-spacing-in-frontend-src-index-css",
      "title": "Adjust the planned-moment pill card styling so the card appears significantly narrower (reduced height/thickness) and more elongated horizontally, while preserving the existing border-only pill look, left color dot, and right-side action icons. Implement this by updating the CSS for the planned-moment card classes used by `frontend/src/components/PlannedMomentCard.tsx` (e.g., `.planned-moment-card-clear`, `.planned-moment-card-color-dot`, and related action/icon sizing/spacing) in `frontend/src/index.css`.",
      "reqIds": [
        "REQ-1"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Refactor Home into a planning-first surface: single-row weekly calendar matching reference design, Start Planning CTA that opens a slide-up planner, and render saved planned-moment cards below the calendar.",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-2",
      "summary": "Planned-moment creation bottom sheet UX: smooth eased translate open/close, ~3/4 height, pill-style inputs, improved time UI, smaller color-coded Cancel/Save buttons, and hide bottom navbar while sheet is open.",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-3",
      "summary": "Planned moments visual system: deterministic pastel color per date, calendar date pill uses that color, and planned-moment cards use matching thin pastel border with no fill; deleting a plan removes the date’s color pill.",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-4",
      "summary": "Enforce one planned moment per day with a friendly side-popup message when user attempts a second plan on the same date.",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-5",
      "summary": "Planned-moment card actions per reference: icons/layout matching reference, share copies generated text to clipboard, delete uses a small custom confirmation modal; cards are pill-shaped and responsive.",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-6",
      "summary": "Navigation update: reorder bottom nav to Home → Vault → Camera → Notifications → Profile, and replace/remove Calendar icon (notifications bell placeholder; no screen needed yet).",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-7",
      "summary": "Camera-first, non-social flow refactor: redesign camera confirmation screen (minimal fields) and remove/de-emphasize feed-like Moments browsing; keep memories private and accessed via Calendar/Vault/Reflection.",
      "reqIds": [],
      "status": "in_progress"
    },
    {
      "id": "AR-8",
      "summary": "Profile enhancements: allow profile picture + name, generate/share invite code, and persist profile locally (backend-ready later).",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Frontend is a React + TypeScript SPA using TanStack Router for routing and TanStack React Query for shared caching (notably backend actor caching keyed by principal).",
    "Mobile UI is built with a consistent fixed full-screen backdrop and a centered “phone frame” viewport constrained to ~390×844, using Tailwind utility classes plus extensive custom CSS.",
    "Design system uses OKLCH CSS variables with Tailwind config mapping tokens (e.g., background/foreground/beige) and many bespoke animations (onboarding 3D card transitions, welcome entrance, bottom sheet transitions, toasts).",
    "Local-first persistence: planned moments, photo moments, and user profile are stored in localStorage; the camera → confirm → feeling flow uses sessionStorage as a transient draft store.",
    "Cross-component and same-tab synchronization uses custom DOM events (plannedMomentsChanged, moments_photos_updated, profile_updated) in addition to the browser 'storage' event for cross-tab updates.",
    "Onboarding/auth flow uses a custom Internet Identity provider around AuthClient and a “smart sign-in” CTA that adapts based on auth state.",
    "Backend is a Motoko canister composed via mixins (authorization + blob-storage maintenance), using an admin bootstrap token from an environment variable and a user-provided secret to assign the first admin.",
    "Home must never show Vault photos/thumbnails/indicators; Home is strictly planning-first (calendar + planning UI + planned-moment cards).",
    "Calendar on Home is a single-row weekly view with horizontal scrolling and month switching, matching the provided reference design; no vault/photo indicators in calendar.",
    "Planned moments are constrained to one per date; attempts to add another are blocked with a friendly side toast/popup.",
    "Planned-moment color is deterministic by date using a muted pastel palette; the same color is used for the calendar date pill and the corresponding planned-moment card border.",
    "Planned-moment cards are pill-shaped, transparent/no-fill, with a thin pastel border; action icons match reference and include share-to-clipboard and delete-with-confirmation.",
    "Planner bottom sheet uses a clean eased translate motion (no bounce), targets ~75% viewport height, and hides the bottom navbar while open."
  ],
  "known_issues": [
    "Two CSS entrypoints exist (frontend/index.css and frontend/src/index.css). The app imports frontend/src/index.css; the extra entrypoint can drift and cause styling confusion.",
    "frontend/src/components/HamburgerMenu.tsx is empty (placeholder).",
    "frontend/src/components/SignInOverlay.tsx is empty (placeholder).",
    "frontend/src/pages/MomentsPage.tsx is empty/unimplemented.",
    "frontend/src/pages/MomentFeelingCheckPage.tsx uses setTimeout for navigation without cleanup; navigation could occur after unmount in edge cases.",
    "CalendarPage defines PhotoMetadata with a dataUrl field, but momentsPhotosStorage persists the image under data; CalendarPage currently uses only timestamp, so the mismatch is latent but confusing.",
    "CameraScreen’s flash toggle is UI-only; the camera hook does not implement torch control.",
    "Backend storePhoto does not persist the provided Blob into blob storage (comment indicates missing put call) and sets metadata timestamp to 0.",
    "backend/main.mo getBlob is a placeholder that always returns null.",
    "Backend canister state (maps/counters/roles) is not stable; data will be lost on upgrade without stable variables and preupgrade/postupgrade handling.",
    "backend/blob-storage/Storage.mo uses env var name 'CAFFFEINE_STORAGE_CASHIER_PRINCIPAL' (likely misspelled), increasing deployment misconfiguration risk.",
    "authorization/access-control.mo traps for unregistered users in getUserRole; callers must ensure initialization occurs for new principals before permission checks.",
    "Intermittent deployment failures were encountered during iterative UI changes (redeploy/build sometimes fails).",
    "Regression risk: planned-date pill color sometimes fails to update immediately after saving a plan (needs verification across flows)."
  ],
  "isFixRequest": false,
  "gameProjectType": "none",
  "projectName": "Moments Mobile App",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}